# GUI 标注编辑器使用说明（PySide6）

本 GUI 用于人工调整检测输出的 per-image JSON 标注文件：**新增框 / 删除框 / 调整框（拖左上角与右下角）**。  
注意：本工具会 **直接覆盖写回** `output.dir` 下的 JSON（不做自动备份）。

## 1. 目录与数据约定

GUI 启动后固定读取“软件根目录”下的配置文件：

- `config/config.toml`

并使用其中的：

- `input.dir`：图片目录（默认 `data/dataset`）
- `output.dir`：标注 JSON 目录（默认 `data/output`）

图片与 JSON 的对应关系：

- 输入：`<input.dir>/sub/a.jpg`
- 输出：`<output.dir>/sub/a.json`（保持相对路径结构，扩展名改为 `.json`）

当某张图片对应的 JSON **不存在**时，GUI 会在首次打开该图片时**直接创建空 JSON**（`detections=[]`）。

## 2. 启动方式

### 2.1 开发/本地运行（推荐）

```bash
uv sync
uv run python scripts/run_gui.py
```

### 2.2 Windows 打包（PyInstaller 目录模式）

在已安装依赖的环境里执行：

```bash
pyinstaller --noconsole --onedir scripts/run_gui.py -n PictureAnnotatorGUI
```

交付给外包同学时，请确保 `dist/PictureAnnotatorGUI/`（软件根目录）下同时包含：

- `config/config.toml`
- `data/dataset/`（图片）
- `data/output/`（标注 JSON，会被覆盖写回）

## 3. 界面说明

- 左侧：图片列表（显示相对路径），支持搜索过滤
- 中间：主画面（渲染图片与框）
- 右侧：框列表（仅显示每个框的 `id`），可选中并删除

## 4. 常用操作（必读）

### 4.1 切换图片

- 直接在左侧图片列表点击
- 工具栏“上一张/下一张”（`PageUp/PageDown`）

切换图片时会自动保存当前图片的标注（包括统一 clamp）。

### 4.2 选择框与高亮

- 在画面中点击某个框（边框区域）即可选中
- 或在右侧框列表点击某个 `id` 选中

选中联动：

- 画面选中 → 列表同步选中
- 列表选中 → 画面同步高亮并居中

颜色规则：

- 未选中：荧光绿
- 选中：荧光橙（并显示角点手柄）

### 4.3 调整框（仅拖角点，不支持拖整框）

选中框后，会出现两个角点手柄：

- 左上角（TL）
- 右下角（BR）

拖动手柄即可调整框位置与大小。规则：

- **不允许越界**：强制 clamp 到图片边界内
- **不允许交叉**：左上角不会被拖到右下角的右下/下方（保证 `xmin<xmax`、`ymin<ymax`）
- **最小尺寸 1px**：宽高至少为 1 像素

### 4.4 新增框

1. 点击工具栏“新增框(A)”进入新增模式（再次点击或按 `A` 退出）
2. 在主画面按住左键拖拽，松开鼠标生成一个新框

新增框写入规则：

- `score = 1.0`
- `id = 当前图片内最大 id + 1`
- 新框追加到 JSON 的 `detections` 列表末尾（保持 JSON 顺序）

### 4.5 删除框

- 在右侧框列表选中一个框
- 点击“删除选中框”或按 `Delete`

删除规则：

- 直接从 `detections` 移除该条，不会重排/归一化其他框的 `id`

### 4.6 保存

触发保存的时机：

- 切换图片时自动保存
- 关闭软件前自动保存
- 工具栏“保存”或 `Ctrl+S`

保存规则（很重要）：

- 保存时会对 **所有框** 执行 clamp（即使你没动过该框）
- 保存只会修改 `detections[*].bbox`（以及创建空 JSON 时的基础字段）；已有 `score` 保留原值

## 5. 坏数据处理（自动提示并丢弃）

打开图片时，如果 JSON 中存在坏框（例如 bbox 非法、不是数字、`xmin>=xmax`、`ymin>=ymax`、缺少 `score` 等）：

- GUI 会弹出中文提示（包含丢弃数量与示例 id）
- 这些坏框会从当前图片的标注中**被丢弃**
- 随后保存（切图/关闭/手动保存）会覆盖写回 JSON，使文件与界面一致

## 6. 缩放与查看

- `Ctrl + 鼠标滚轮`：缩放
- 鼠标拖动：平移画面
- 工具栏“适配窗口”：一键适配当前图片到窗口

## 7. 常见问题

- **提示“未找到配置文件”**：请检查软件根目录下是否存在 `config/config.toml`。
- **打开图片失败**：确认图片格式与 `input.extensions` 匹配，且文件未损坏。
- **保存失败**：多为输出目录无写权限或磁盘只读；修复权限后重试。

